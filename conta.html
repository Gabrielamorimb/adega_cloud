<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Conta - Estoque Fácil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Configuração do Tailwind para cores personalizadas */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        /* Animações suaves */
        .animate-fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease-out;
        }

        .animate-scale-in {
            animation: scaleIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Background com padrão sutil */
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            background-attachment: fixed;
        }

        /* Sidebar moderna */
        .sidebar {
            background: linear-gradient(180deg, #1a202c 0%, #2d3748 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar.collapsed .hidden-text {
            display: none;
        }

        /* Cards com glassmorphism */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
        }

        /* Header moderno */
        .modern-header {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-bottom: 2px solid #e2e8f0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        /* Inputs modernos */
        .modern-input {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.875rem 1.25rem;
            font-size: 1rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .modern-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            outline: none;
            transform: translateY(-1px);
        }

        .modern-input:disabled {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #6b7280;
            cursor: not-allowed;
            border-color: #d1d5db;
        }

        /* Select moderno */
        .modern-select {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.875rem 1.25rem;
            font-size: 1rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }

        .modern-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            outline: none;
            transform: translateY(-1px);
        }

        /* Labels modernos */
        .modern-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            font-size: 0.875rem;
        }

        .modern-label i {
            margin-right: 0.5rem;
            color: #667eea;
        }

        /* Botões modernos */
        .modern-btn {
            background: var(--primary-gradient);
            color: white;
            padding: 0.875rem 2rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .modern-btn:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .modern-btn:active {
            transform: translateY(0);
        }

        .modern-btn.secondary {
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            box-shadow: 0 4px 15px rgba(107, 114, 128, 0.3);
        }

        .modern-btn.secondary:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.4);
        }

        .modern-btn.success {
            background: var(--success-gradient);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .modern-btn.success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        .scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        /* Toast notification moderna */
        .toast-modern {
            background: var(--primary-gradient);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        .toast-error {
            background: var(--danger-gradient);
        }

        .toast-success {
            background: var(--success-gradient);
        }

        /* Seções de formulário */
        .form-section {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .form-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
        }

        .form-section h2 {
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Divisor moderno */
        .modern-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent 0%, #e2e8f0 50%, transparent 100%);
            margin: 1.5rem 0;
            border: none;
        }

        /* Container principal */
        .main-container {
            max-width: 4xl;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Grid responsivo */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Efeitos de foco */
        .focus-ring:focus-within {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        /* Ícones animados */
        .animated-icon {
            transition: all 0.2s ease;
        }

        .animated-icon:hover {
            transform: scale(1.1);
            color: #667eea;
        }

        /* Card de plano */
        .plan-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .plan-card.active {
            border-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .plan-card.expired {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        }

        .plan-badge {
            position: absolute;
            top: -8px;
            right: 16px;
            padding: 0.25rem 0.75rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            color: white;
        }

        .plan-badge.active {
            background: var(--success-gradient);
        }

        .plan-badge.expired {
            background: var(--danger-gradient);
        }

        .plan-badge.trial {
            background: var(--warning-gradient);
        }

        /* Melhorias para responsividade */
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem;
            }
            
            .form-section {
                padding: 1.5rem;
            }
            
            .modern-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar moderna -->
        <aside class="sidebar w-64 text-white flex-col flex-shrink-0 hidden md:flex animate-slide-up">
            <div class="flex items-center justify-center h-20 border-b border-gray-700 border-opacity-50">
                <a href="dashboard.html" class="flex items-center group">
                    <i class="fas fa-box text-blue-400 mr-3 text-2xl group-hover:scale-110 transition-transform duration-300"></i>
                    <span class="text-xl font-bold hidden-text bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">Estoque Fácil</span>
                </a>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="dashboard.html" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gradient-to-r hover:from-gray-700 hover:to-gray-600 hover:text-white rounded-xl transition-all duration-300">
                    <i class="fas fa-home h-6 w-6 mr-3"></i>
                    <span class="hidden-text font-medium">Dashboard</span>
                </a>
                <a href="inventario.html" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gradient-to-r hover:from-gray-700 hover:to-gray-600 hover:text-white rounded-xl transition-all duration-300">
                    <i class="fas fa-archive h-6 w-6 mr-3"></i>
                    <span class="hidden-text font-medium">Inventário</span>
                </a>
                <a href="vendas.html" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gradient-to-r hover:from-gray-700 hover:to-gray-600 hover:text-white rounded-xl transition-all duration-300">
                    <i class="fas fa-shopping-cart h-6 w-6 mr-3"></i>
                    <span class="hidden-text font-medium">PDV - Vendas</span>
                </a>
                <a href="relatorios.html" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gradient-to-r hover:from-gray-700 hover:to-gray-600 hover:text-white rounded-xl transition-all duration-300">
                    <i class="fas fa-chart-bar h-6 w-6 mr-3"></i>
                    <span class="hidden-text font-medium">Relatórios</span>
                </a>
                <a href="conta.html" class="flex items-center px-4 py-3 text-white bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl transition-all duration-300 shadow-lg">
                    <i class="fas fa-user-circle h-6 w-6 mr-3"></i>
                    <span class="hidden-text font-medium">Minha Conta</span>
                </a>
            </nav>
            <div class="px-4 py-4 border-t border-gray-700 border-opacity-50">
                <button id="logout-button" class="w-full flex items-center justify-center px-4 py-3 text-gray-300 hover:bg-gradient-to-r hover:from-red-600 hover:to-red-500 hover:text-white rounded-xl transition-all duration-300">
                    <i class="fas fa-sign-out-alt h-6 w-6 mr-3"></i>
                    <span class="hidden-text font-medium">Sair</span>
                </button>
            </div>
            <div class="p-2 text-center">
                <button id="toggle-sidebar" class="text-gray-400 hover:text-white transition-colors duration-300">
                    <i class="fas fa-chevron-left text-lg"></i>
                </button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Header moderno -->
            <header class="modern-header p-6 flex justify-between items-center animate-fade-in">
                <div>
                    <h1 class="text-3xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent flex items-center">
                        <i class="fas fa-user-cog mr-3 text-blue-600 animated-icon"></i>
                        Minha Conta
                    </h1>
                    <p class="text-gray-600 mt-1">Gerencie suas informações pessoais e configurações</p>
                </div>
                <div class="hidden md:flex items-center space-x-4">
                    <div class="flex items-center text-sm text-gray-500">
                        <i class="fas fa-shield-alt mr-2 text-green-500"></i>
                        Conta Segura
                    </div>
                </div>
            </header>

            <main class="flex-1 overflow-y-auto">
                <div class="main-container animate-scale-in">
                    <div class="space-y-8">
                        <!-- Seção de Status do Plano -->
                        <div class="form-section">
                            <h2>
                                <i class="fas fa-crown text-2xl"></i>
                                Status do Plano
                            </h2>
                            <p class="text-gray-600 mb-6">Informações sobre sua assinatura atual</p>
                            
                            <div id="plan-status-container">
                                <!-- Conteúdo será preenchido dinamicamente -->
                            </div>
                        </div>

                        <!-- Seção de Dados do Perfil -->
                        <div class="form-section">
                            <h2>
                                <i class="fas fa-user-edit text-2xl"></i>
                                Dados do Perfil
                            </h2>
                            <p class="text-gray-600 mb-6">Mantenha suas informações pessoais sempre atualizadas</p>
                            
                            <form id="profile-form" class="space-y-6">
                                <div class="form-grid">
                                    <div class="focus-ring">
                                        <label for="full-name" class="modern-label">
                                            <i class="fas fa-user"></i>
                                            Nome completo
                                        </label>
                                        <input type="text" id="full-name" required class="modern-input w-full" placeholder="Digite seu nome completo">
                                    </div>
                                    <div class="focus-ring">
                                        <label for="business-name" class="modern-label">
                                            <i class="fas fa-store"></i>
                                            Nome do estabelecimento
                                        </label>
                                        <input type="text" id="business-name" required class="modern-input w-full" placeholder="Nome da sua empresa">
                                    </div>
                                </div>
                                
                                <div class="focus-ring">
                                    <label for="email" class="modern-label">
                                        <i class="fas fa-envelope"></i>
                                        E-mail (não pode ser alterado)
                                    </label>
                                    <input type="email" id="email" disabled class="modern-input w-full">
                                </div>
                                
                                <div class="form-grid">
                                    <div class="focus-ring">
                                        <label for="phone" class="modern-label">
                                            <i class="fas fa-phone"></i>
                                            Telefone
                                        </label>
                                        <input type="tel" id="phone" required class="modern-input w-full" placeholder="(11) 99999-9999">
                                    </div>
                                    <div class="focus-ring">
                                        <label for="state" class="modern-label">
                                            <i class="fas fa-map-marker-alt"></i>
                                            Estado
                                        </label>
                                        <select id="state" name="state" class="modern-select w-full">
                                            <option value="">Selecione seu estado</option>
                                            <option value="AC">Acre</option>
                                            <option value="AL">Alagoas</option>
                                            <option value="AP">Amapá</option>
                                            <option value="AM">Amazonas</option>
                                            <option value="BA">Bahia</option>
                                            <option value="CE">Ceará</option>
                                            <option value="DF">Distrito Federal</option>
                                            <option value="ES">Espírito Santo</option>
                                            <option value="GO">Goiás</option>
                                            <option value="MA">Maranhão</option>
                                            <option value="MT">Mato Grosso</option>
                                            <option value="MS">Mato Grosso do Sul</option>
                                            <option value="MG">Minas Gerais</option>
                                            <option value="PA">Pará</option>
                                            <option value="PB">Paraíba</option>
                                            <option value="PR">Paraná</option>
                                            <option value="PE">Pernambuco</option>
                                            <option value="PI">Piauí</option>
                                            <option value="RJ">Rio de Janeiro</option>
                                            <option value="RN">Rio Grande do Norte</option>
                                            <option value="RS">Rio Grande do Sul</option>
                                            <option value="RO">Rondônia</option>
                                            <option value="RR">Roraima</option>
                                            <option value="SC">Santa Catarina</option>
                                            <option value="SP">São Paulo</option>
                                            <option value="SE">Sergipe</option>
                                            <option value="TO">Tocantins</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="flex justify-end">
                                    <button type="submit" class="modern-btn">
                                        <i class="fas fa-save"></i>
                                        Salvar Alterações
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Seção de Alterar Senha -->
                        <div class="form-section">
                            <h2>
                                <i class="fas fa-key text-2xl"></i>
                                Alterar Senha
                            </h2>
                            <p class="text-gray-600 mb-6">Mantenha sua conta segura com uma senha forte</p>
                            
                            <form id="password-form" class="space-y-6">
                                <div class="focus-ring">
                                    <label for="current_password" class="modern-label">
                                        <i class="fas fa-lock"></i>
                                        Senha Atual
                                    </label>
                                    <input type="password" id="current_password" required class="modern-input w-full" placeholder="Digite sua senha atual">
                                </div>
                                
                                <hr class="modern-divider">
                                
                                <div class="focus-ring">
                                    <label for="new_password" class="modern-label">
                                        <i class="fas fa-lock-open"></i>
                                        Nova Senha
                                    </label>
                                    <input type="password" id="new_password" required placeholder="Mínimo 6 caracteres" class="modern-input w-full">
                                    <p class="text-sm text-gray-500 mt-2 flex items-center">
                                        <i class="fas fa-info-circle mr-2"></i>
                                        Use pelo menos 6 caracteres com letras e números
                                    </p>
                                </div>
                                
                                <div class="focus-ring">
                                    <label for="confirm_new_password" class="modern-label">
                                        <i class="fas fa-check-circle"></i>
                                        Confirme a Nova Senha
                                    </label>
                                    <input type="password" id="confirm_new_password" required class="modern-input w-full" placeholder="Digite novamente a nova senha">
                                </div>
                                
                                <div class="flex justify-end">
                                    <button type="submit" class="modern-btn secondary">
                                        <i class="fas fa-shield-alt"></i>
                                        Redefinir Senha
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast notification moderna -->
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 toast-modern text-white px-6 py-4 rounded-2xl shadow-2xl transform translate-y-20 opacity-0">
        <p id="toast-message" class="font-medium"></p>
    </div>

    <script>
        const SUPABASE_URL = 'https://urffzwmchbbeddpanopp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyZmZ6d21jaGJiZWRkcGFub3BwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2NzE2MjcsImV4cCI6MjA2ODI0NzYyN30.OtBoVWqlFdoBeQx2-gYwzVPV2tALQ2xM6AK45kcpdQc';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;

        async function checkLoginStatus() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return null;
            }
            return session.user;
        }

        document.getElementById('logout-button').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        });

        const profileForm = document.getElementById('profile-form');
        const passwordForm = document.getElementById('password-form');
        const toast = document.getElementById('toast-notification');
        const toastMessage = document.getElementById('toast-message');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');
        const sidebar = document.querySelector('.sidebar');

        function showToast(message, type = 'info') {
            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'translate-y-20', 'opacity-0', 'toast-modern', 'toast-error', 'toast-success');
            
            if (type === 'error') {
                toast.classList.add('toast-error');
            } else if (type === 'success') {
                toast.classList.add('toast-success');
            } else {
                toast.classList.add('toast-modern');
            }
            
            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        toggleSidebarBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            const icon = toggleSidebarBtn.querySelector('i');
            if (sidebar.classList.contains('collapsed')) {
                icon.classList.remove('fa-chevron-left');
                icon.classList.add('fa-chevron-right');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
            }
        });

        async function fetchAndDisplayProfile(user) {
            try {
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();

                if (error) throw error;

                if (profile) {
                    document.getElementById('full-name').value = profile.full_name || '';
                    document.getElementById('business-name').value = profile.business_name || '';
                    document.getElementById('email').value = user.email;
                    document.getElementById('phone').value = profile.phone || '';
                    document.getElementById('state').value = profile.state || '';
                    
                    // Exibir status do plano
                    displayPlanStatus(profile);
                }
            } catch (error) {
                console.error('Erro ao buscar perfil:', error);
                showToast('Não foi possível carregar seus dados.', 'error');
            }
        }

        function displayPlanStatus(profile) {
            const container = document.getElementById('plan-status-container');
            const status = profile.subscription_status;
            const trialEndDate = profile.trial_ends_at ? new Date(profile.trial_ends_at) : null;
            const subscriptionEndDate = profile.subscription_ends_at ? new Date(profile.subscription_ends_at) : null;
            const now = new Date();

            let planHtml = '';
            let planClass = '';
            let badgeClass = '';
            let badgeText = '';
            let statusText = '';
            let actionButton = '';

            if (status === 'active') {
                planClass = 'active';
                badgeClass = 'active';
                badgeText = 'Ativo';
                statusText = `Seu plano está ativo até ${subscriptionEndDate ? subscriptionEndDate.toLocaleDateString('pt-BR') : 'data não definida'}`;
                actionButton = `
                    <button onclick="upgradePlan()" class="modern-btn success">
                        <i class="fas fa-arrow-up"></i>
                        Alterar Plano
                    </button>
                `;
            } else if (status === 'trialing') {
                if (trialEndDate && now <= trialEndDate) {
                    planClass = 'active';
                    badgeClass = 'trial';
                    badgeText = 'Trial';
                    const daysLeft = Math.ceil((trialEndDate - now) / (1000 * 60 * 60 * 24));
                    statusText = `Seu período de teste expira em ${daysLeft} dia${daysLeft > 1 ? 's' : ''} (${trialEndDate.toLocaleDateString('pt-BR')})`;
                    actionButton = `
                        <button onclick="upgradePlan()" class="modern-btn success">
                            <i class="fas fa-crown"></i>
                            Assinar Agora
                        </button>
                    `;
                } else {
                    planClass = 'expired';
                    badgeClass = 'expired';
                    badgeText = 'Expirado';
                    statusText = 'Seu período de teste expirou. Assine um plano para continuar usando o sistema.';
                    actionButton = `
                        <button onclick="upgradePlan()" class="modern-btn success">
                            <i class="fas fa-credit-card"></i>
                            Assinar Plano
                        </button>
                    `;
                }
            } else {
                planClass = 'expired';
                badgeClass = 'expired';
                badgeText = 'Inativo';
                statusText = 'Sua conta não possui um plano ativo. Assine um plano para usar o sistema.';
                actionButton = `
                    <button onclick="upgradePlan()" class="modern-btn success">
                        <i class="fas fa-credit-card"></i>
                        Assinar Plano
                    </button>
                `;
            }

            planHtml = `
                <div class="plan-card ${planClass}">
                    <div class="plan-badge ${badgeClass}">${badgeText}</div>
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">
                                <i class="fas fa-star mr-2 text-yellow-500"></i>
                                Plano Premium
                            </h3>
                            <p class="text-gray-600 mb-4">${statusText}</p>
                            <div class="flex items-center text-sm text-gray-500">
                                <i class="fas fa-check-circle mr-2 text-green-500"></i>
                                Recursos ilimitados
                            </div>
                        </div>
                        <div class="text-right">
                            ${actionButton}
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = planHtml;
        }

        function upgradePlan() {
            // Redireciona para a página de planos com o email do usuário
            window.location.href = `planos.html?email=${encodeURIComponent(currentUser.email)}`;
        }

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const updates = {
                full_name: document.getElementById('full-name').value,
                business_name: document.getElementById('business-name').value,
                phone: document.getElementById('phone').value,
                state: document.getElementById('state').value,
                updated_at: new Date()
            };

            const { error } = await supabaseClient.from('profiles').update(updates).eq('id', currentUser.id);

            if (error) {
                showToast('Erro ao atualizar perfil.', 'error');
                console.error(error);
            } else {
                showToast('Perfil atualizado com sucesso!', 'success');
            }
        });

        passwordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const currentPassword = document.getElementById('current_password').value;
            const newPassword = document.getElementById('new_password').value;
            const confirmNewPassword = document.getElementById('confirm_new_password').value;

            if (!currentPassword || !newPassword) {
                showToast('Por favor, preencha todos os campos de senha.', 'error');
                return;
            }

            if (newPassword.length < 6) {
                showToast('A nova senha precisa ter no mínimo 6 caracteres.', 'error');
                return;
            }

            if (newPassword !== confirmNewPassword) {
                showToast('As novas senhas não coincidem.', 'error');
                return;
            }

            const { error } = await supabaseClient.auth.updateUser({
                password: newPassword
            });

            if (error) {
                showToast('Erro ao atualizar a senha. Verifique sua senha atual.', 'error');
                console.error(error);
            } else {
                showToast('Senha alterada com sucesso!', 'success');
                passwordForm.reset();
            }
        });

        async function initializePage() {
            currentUser = await checkLoginStatus();
            if (currentUser) {
                await fetchAndDisplayProfile(currentUser);
            }
        }

        initializePage();
    </script>
</body>
</html>

