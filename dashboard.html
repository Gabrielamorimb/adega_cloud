<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Estoque F√°cil</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Configura√ß√£o do Tailwind para cores personalizadas */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        /* Anima√ß√µes suaves */
        .animate-fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        .animate-slide-up {
            animation: slideUp 0.5s ease-out;
        }

        .animate-scale-in {
            animation: scaleIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes scaleIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Cards com gradientes e glassmorphism */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .gradient-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Bot√µes de filtro modernos */
        .filter-btn {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .filter-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .filter-btn:hover::before {
            left: 100%;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        /* Sidebar moderna */
        .sidebar {
            background: linear-gradient(180deg, #1a202c 0%, #2d3748 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar.collapsed .hidden-text {
            display: none;
        }

        /* Cards de KPI com hover effects */
        .kpi-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .kpi-card:hover::before {
            transform: scaleX(1);
        }

        .kpi-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        /* Action cards com gradientes */
        .action-card-primary {
            background: var(--primary-gradient);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .action-card-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .action-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
        }

        /* Tabela moderna */
        .modern-table {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        .modern-table thead {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }

        .modern-table tbody tr {
            transition: all 0.2s ease;
        }

        .modern-table tbody tr:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            transform: scale(1.01);
        }

        /* Badges de tipo de venda */
        .type-badge-unit {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        .type-badge-package {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* Badge para desconto aplicado */
        .discount-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        /* √çcones com anima√ß√£o */
        .icon-bounce {
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 20%, 53%, 80%, 100% {
                transform: translate3d(0,0,0);
            }
            40%, 43% {
                transform: translate3d(0, -8px, 0);
            }
            70% {
                transform: translate3d(0, -4px, 0);
            }
            90% {
                transform: translate3d(0, -2px, 0);
            }
        }

        /* Background com padr√£o sutil */
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            background-attachment: fixed;
        }

        /* Apexcharts customiza√ß√£o */
        .apexcharts-canvas {
            margin: 0 auto;
        }

        /* Toast notification moderna */
        .toast-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        /* Estados vazios */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #d1d5db;
        }

        /* ESTILOS PARA O ALERTA DE PLANO */
        .plan-alert {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border: 1px solid rgba(251, 191, 36, 0.3);
            animation: slideDown 0.5s ease-out;
        }

        .plan-alert.trial-ending {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .plan-alert.premium {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .plan-alert .close-btn {
            transition: all 0.2s ease;
        }

        .plan-alert .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar moderna -->
        <aside class="sidebar w-64 text-white flex-col flex-shrink-0 hidden md:flex animate-slide-up">
            <div class="flex items-center justify-center h-20 border-b border-gray-700 border-opacity-50">
                <a href="dashboard.html" class="flex items-center group">
                    <i class="fas fa-box text-blue-400 mr-3 text-2xl group-hover:scale-110 transition-transform duration-300"></i>
                    <span class="text-xl font-bold hidden-text bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">Estoque F√°cil</span>
                </a>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-2">
                <a href="dashboard.html" class="flex items-center px-4 py-3 text-white bg-gradient-to-r from-blue-500 to-purple-600 rounded-xl transition-all duration-300 shadow-lg">
                    <i class="fas fa-home h-6 w-6 mr-3"></i>
                    <span class="hidden-text font-medium">Dashboard</span>
                </a>
                <a href="inventario.html" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gradient-to-r hover:from-gray-700 hover:to-gray-600 hover:text-white rounded-xl transition-all duration-300">
                    <i class="fas fa-archive h-6 w-6 mr-3"></i>
                    <span class="hidden-text font-medium">Invent√°rio</span>
                </a>
                <a href="vendas.html" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gradient-to-r hover:from-gray-700 hover:to-gray-600 hover:text-white rounded-xl transition-all duration-300">
                    <i class="fas fa-shopping-cart h-6 w-6 mr-3"></i>
                    <span class="hidden-text font-medium">PDV - Vendas</span>
                </a>
                 <a href="relatorios.html" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gradient-to-r hover:from-gray-700 hover:to-gray-600 hover:text-white rounded-xl transition-all duration-300">
                    <i class="fas fa-chart-bar h-6 w-6 mr-3"></i>
                    <span class="hidden-text font-medium">Relat√≥rios</span>
                </a>
                <a href="conta.html" class="flex items-center px-4 py-3 text-gray-300 hover:bg-gradient-to-r hover:from-gray-700 hover:to-gray-600 hover:text-white rounded-xl transition-all duration-300">
                    <i class="fas fa-user-circle h-6 w-6 mr-3"></i>
                    <span class="hidden-text font-medium">Minha Conta</span>
                </a>
            </nav>
            <div class="px-4 py-4 border-t border-gray-700 border-opacity-50">
                <button id="logout-button" class="w-full flex items-center justify-center px-4 py-3 text-gray-300 hover:bg-gradient-to-r hover:from-red-600 hover:to-red-500 hover:text-white rounded-xl transition-all duration-300">
                    <i class="fas fa-sign-out-alt h-6 w-6 mr-3"></i>
                    <span class="hidden-text font-medium">Sair</span>
                </button>
            </div>
            <div class="p-2 text-center">
                <button id="toggle-sidebar" class="text-gray-400 hover:text-white transition-colors duration-300">
                    <i class="fas fa-chevron-left text-lg"></i>
                </button>
            </div>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- ALERTA DE PLANO - NOVO ELEMENTO -->
            <div id="plan-alert" class="plan-alert text-white px-6 py-4 flex items-center justify-between shadow-lg hidden">
                <div class="flex items-center space-x-4">
                    <div class="bg-white bg-opacity-20 p-2 rounded-full">
                        <i id="plan-alert-icon" class="fas fa-clock text-lg"></i>
                    </div>
                    <div>
                        <h4 id="plan-alert-title" class="font-bold text-lg">Per√≠odo de Teste</h4>
                        <p id="plan-alert-message" class="text-sm opacity-90">Carregando informa√ß√µes do plano...</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="close-plan-alert" class="close-btn bg-white bg-opacity-10 hover:bg-opacity-20 p-2 rounded-full transition-all duration-200">
                        <i class="fas fa-times text-sm"></i>
                    </button>
                </div>
            </div>

            <!-- Header moderno -->
            <header class="glass-card shadow-lg p-6 flex justify-between items-center animate-fade-in">
                <div>
                    <h1 id="welcome-message" class="text-3xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">Dashboard</h1>
                    <p class="text-gray-500 mt-1">Vis√£o geral do seu neg√≥cio</p>
                </div>
                <div id="period-filters" class="flex items-center bg-gradient-to-r from-gray-100 to-gray-200 rounded-2xl p-2 space-x-2 shadow-inner">
                    <button class="filter-btn px-4 py-2 text-sm font-semibold rounded-xl text-gray-600" data-period="today">Hoje</button>
                    <button class="filter-btn px-4 py-2 text-sm font-semibold rounded-xl text-gray-600" data-period="last7days">7 Dias</button>
                    <button class="filter-btn px-4 py-2 text-sm font-semibold rounded-xl text-gray-600" data-period="this_month">Este M√™s</button>
                </div>
            </header>

            <main id="dashboard-content" class="flex-1 overflow-y-auto p-6 opacity-0 transition-opacity duration-500">
                <!-- Action Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 animate-slide-up">
                    <a href="vendas.html" class="action-card action-card-primary text-white p-8 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 flex items-center space-x-6 group">
                        <div class="bg-white bg-opacity-20 p-4 rounded-2xl group-hover:scale-110 transition-transform duration-300">
                            <i class="fas fa-cart-plus h-8 w-8"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-2xl mb-2">Registrar Nova Venda</h3>
                            <p class="text-blue-100 opacity-90">Ir para o Ponto de Venda (PDV)</p>
                        </div>
                    </a>
                    <a href="inventario.html" class="action-card action-card-secondary text-white p-8 rounded-2xl shadow-xl hover:shadow-2xl transition-all duration-300 flex items-center space-x-6 group">
                        <div class="bg-white bg-opacity-20 p-4 rounded-2xl group-hover:scale-110 transition-transform duration-300">
                            <i class="fas fa-boxes h-8 w-8"></i>
                        </div>
                        <div>
                            <h3 class="font-bold text-2xl mb-2">Gerenciar Invent√°rio</h3>
                            <p class="text-purple-100 opacity-90">Cadastrar e editar produtos</p>
                        </div>
                    </a>
                </div>

                <!-- KPI Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 animate-scale-in">
                    <div class="kpi-card glass-card p-6 rounded-2xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Faturamento</h4>
                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 p-2 rounded-lg">
                                <i class="fas fa-dollar-sign text-white text-sm"></i>
                            </div>
                        </div>
                        <p id="faturamento-valor" class="text-3xl font-bold bg-gradient-to-r from-blue-600 to-blue-800 bg-clip-text text-transparent">R$ 0,00</p>
                        <div class="mt-2 flex items-center text-sm text-green-600">
                            <i class="fas fa-arrow-up mr-1"></i>
                            <span>Per√≠odo atual</span>
                        </div>
                    </div>

                    <div class="kpi-card glass-card p-6 rounded-2xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Lucro Bruto</h4>
                            <div class="bg-gradient-to-r from-green-500 to-green-600 p-2 rounded-lg">
                                <i class="fas fa-chart-line text-white text-sm"></i>
                            </div>
                        </div>
                        <p id="lucro-valor" class="text-3xl font-bold bg-gradient-to-r from-green-600 to-green-800 bg-clip-text text-transparent">R$ 0,00</p>
                        <div class="mt-2 flex items-center text-sm text-green-600">
                            <i class="fas fa-arrow-up mr-1"></i>
                            <span>Margem positiva</span>
                        </div>
                    </div>

                    <div class="kpi-card glass-card p-6 rounded-2xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Margem de Lucro</h4>
                            <div class="bg-gradient-to-r from-purple-500 to-purple-600 p-2 rounded-lg">
                                <i class="fas fa-percentage text-white text-sm"></i>
                            </div>
                        </div>
                        <p id="margem-valor" class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-purple-800 bg-clip-text text-transparent">0%</p>
                        <div class="mt-2 flex items-center text-sm text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            <span>Rentabilidade</span>
                        </div>
                    </div>

                    <div class="kpi-card glass-card p-6 rounded-2xl shadow-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Estoque Baixo</h4>
                            <div class="bg-gradient-to-r from-red-500 to-red-600 p-2 rounded-lg">
                                <i class="fas fa-exclamation-triangle text-white text-sm icon-bounce"></i>
                            </div>
                        </div>
                        <p id="estoque-baixo-valor" class="text-3xl font-bold bg-gradient-to-r from-red-600 to-red-800 bg-clip-text text-transparent">0</p>
                        <button id="low-stock-filter-btn" class="mt-3 bg-gradient-to-r from-red-100 to-red-200 text-red-800 px-4 py-2 rounded-xl text-sm font-medium hover:from-red-200 hover:to-red-300 transition-all duration-300 shadow-sm">
                            <i class="fas fa-eye mr-2"></i> Ver Itens
                        </button>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8 animate-fade-in">
                    <div class="lg:col-span-2 glass-card p-8 rounded-2xl shadow-lg">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">An√°lise de Vendas</h3>
                            <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-2 rounded-lg">
                                <i class="fas fa-chart-bar text-white"></i>
                            </div>
                        </div>
                        <div id="sales-chart"></div>
                    </div>
                    <div class="glass-card p-8 rounded-2xl shadow-lg">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">Top Produtos</h3>
                            <div class="bg-gradient-to-r from-green-500 to-blue-600 p-2 rounded-lg">
                                <i class="fas fa-trophy text-white"></i>
                            </div>
                        </div>
                        <div id="top-products-chart"></div>
                    </div>
                </div>

                <!-- Recent Sales Table - ORDEM MODIFICADA: PRE√áO UNIT., DESCONTO, FATURAMENTO -->
                <div class="glass-card p-8 rounded-2xl shadow-lg animate-slide-up">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold bg-gradient-to-r from-gray-800 to-gray-600 bg-clip-text text-transparent">√öltimas 10 Vendas</h3>
                        <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-2 rounded-lg">
                            <i class="fas fa-history text-white"></i>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="modern-table min-w-full">
                            <thead>
                                <tr>
                                    <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Data</th>
                                    <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Produto</th>
                                    <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Categoria</th>
                                    <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Tipo</th>
                                    <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Quantidade</th>
                                    <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Pre√ßo Unit.</th>
                                    <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Desconto</th>
                                    <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Faturamento</th>
                                    <th scope="col" class="px-6 py-4 text-left text-xs font-bold text-gray-600 uppercase tracking-wider">Lucro</th>
                                </tr>
                            </thead>
                            <tbody id="recent-sales" class="divide-y divide-gray-200">
                                <!-- Recent sales will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast notification moderna -->
    <div id="toast-notification" class="hidden fixed bottom-5 right-5 toast-modern text-white px-6 py-4 rounded-2xl shadow-2xl transform translate-y-20 opacity-0">
        <p id="toast-message" class="font-medium"></p>
    </div>

    <script>
        const SUPABASE_URL = 'https://urffzwmchbbeddpanopp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVyZmZ6d21jaGJiZWRkcGFub3BwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2NzE2MjcsImV4cCI6MjA2ODI0NzYyN30.OtBoVWqlFdoBeQx2-gYwzVPV2tALQ2xM6AK45kcpdQc';
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;

        // Sidebar toggle functionality
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');
        const sidebar = document.querySelector('.sidebar');
        toggleSidebarBtn.addEventListener('click', () => {
            sidebar.classList.toggle('collapsed');
            const icon = toggleSidebarBtn.querySelector('i');
            if (sidebar.classList.contains('collapsed')) {
                icon.classList.remove('fa-chevron-left');
                icon.classList.add('fa-chevron-right');
            } else {
                icon.classList.remove('fa-chevron-right');
                icon.classList.add('fa-chevron-left');
            }
        });

        // Fun√ß√µes de utilidade
        function formatCurrency(value) {
            return `R$ ${value.toFixed(2).replace('.', ',')}`;
        }

        function formatDate(date) {
            return new Date(date).toLocaleDateString('pt-BR');
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.classList.remove('hidden', 'translate-y-20', 'opacity-0');
            
            if (type === 'error') {
                toast.classList.add('bg-red-500'); // Tailwind class for error
            } else if (type === 'success') {
                toast.classList.add('bg-green-500'); // Tailwind class for success
            } else {
                toast.classList.add('bg-blue-500'); // Tailwind class for info
            }

            setTimeout(() => {
                toast.classList.add('translate-y-20', 'opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 3000);
        }

        // FUN√á√ÉO ATUALIZADA: Buscar dados do plano do usu√°rio
        async function fetchUserPlanData() {
            try {
                console.log('üîç Buscando dados do plano do usu√°rio...');
                
                const { data: profile, error } = await supabaseClient
                    .from('profiles')
                    .select('state, subscription_status, trial_ends_at, subscription_ends_at, full_name') // Adicionado subscription_ends_at
                    .eq('id', currentUser.id)
                    .single();

                if (error) {
                    console.error('‚ùå Erro ao buscar dados do plano:', error);
                    return null;
                }

                console.log('üìä Dados do plano recebidos:', profile);
                return profile;
            } catch (error) {
                console.error('‚ùå Erro ao buscar dados do plano:', error);
                return null;
            }
        }

        // FUN√á√ÉO ATUALIZADA: Exibir alerta do plano
        function displayPlanAlert(planData) {
            const alertElement = document.getElementById('plan-alert');
            const iconElement = document.getElementById('plan-alert-icon');
            const titleElement = document.getElementById('plan-alert-title');
            const messageElement = document.getElementById('plan-alert-message');

            if (!planData) {
                alertElement.classList.add('hidden');
                return;
            }

            const status = planData.subscription_status;
            const trialEndDate = planData.trial_ends_at ? new Date(planData.trial_ends_at) : null;
            const subscriptionEndDate = planData.subscription_ends_at ? new Date(planData.subscription_ends_at) : null;
            const now = new Date();

            let alertClass = '';
            let icon = '';
            let title = '';
            let message = '';

            // Resetar classes CSS
            alertElement.className = 'plan-alert text-white px-6 py-4 flex items-center justify-between shadow-lg';

            if (status === 'active') {
                if (subscriptionEndDate && subscriptionEndDate > now) {
                    const daysLeft = Math.ceil((subscriptionEndDate - now) / (1000 * 60 * 60 * 24));
                    alertClass = 'premium';
                    icon = 'fas fa-check-circle';
                    title = 'Plano Ativo';
                    message = `Seu plano premium est√° ativo! Expira em ${daysLeft} dia${daysLeft !== 1 ? 's' : ''} (${formatDate(subscriptionEndDate)}).`;
                } else {
                    // Caso o status seja 'active' mas a data de expira√ß√£o j√° passou (erro ou n√£o atualizado)
                    alertClass = 'trial-ending'; // Usar estilo de expirado
                    icon = 'fas fa-exclamation-circle';
                    title = 'Plano Expirado';
                    message = 'Seu plano ativo expirou. Por favor, renove sua assinatura para continuar usando o sistema.';
                }
            } else if (status === 'trialing') {
                if (trialEndDate && trialEndDate > now) {
                    const daysLeft = Math.ceil((trialEndDate - now) / (1000 * 60 * 60 * 24));
                    if (daysLeft <= 3) {
                        alertClass = 'trial-ending'; // Vermelho para √∫ltimos dias
                        icon = 'fas fa-exclamation-triangle';
                        title = 'Teste Gr√°tis Quase Expirando!';
                        message = `Seu per√≠odo de teste expira em ${daysLeft} dia${daysLeft !== 1 ? 's' : ''}. Assine agora para n√£o perder o acesso!`;
                    } else {
                        alertClass = ''; // Amarelo padr√£o para trial
                        icon = 'fas fa-clock';
                        title = 'Per√≠odo de Teste Ativo';
                        message = `Voc√™ tem ${daysLeft} dia${daysLeft !== 1 ? 's' : ''} restantes no seu teste gratuito.`;
                    }
                } else {
                    alertClass = 'trial-ending'; // Vermelho para expirado
                    icon = 'fas fa-times-circle';
                    title = 'Teste Gr√°tis Expirado!';
                    message = 'Seu per√≠odo de teste gratuito terminou. Assine um plano para continuar usando o sistema.';
                }
            } else {
                // Status 'inactive' ou qualquer outro que n√£o seja 'active' ou 'trialing'
                alertClass = 'trial-ending'; // Vermelho para inativo/expirado
                icon = 'fas fa-ban';
                title = 'Acesso Restrito';
                message = 'Sua conta n√£o possui um plano ativo. Assine um plano para usar o sistema.';
            }

            // Aplicar estilo baseado no status
            if (alertClass) {
                alertElement.classList.add(alertClass);
            }

            // Atualizar conte√∫do
            iconElement.className = `${icon} text-lg`;
            titleElement.textContent = title;
            messageElement.textContent = message;

            // Exibir o alerta
            alertElement.classList.remove('hidden');
        }

        // Event listeners para o alerta de plano
        document.getElementById('close-plan-alert').addEventListener('click', () => {
            document.getElementById('plan-alert').classList.add('hidden');
        });

        // Initialization of charts with modern options
        const salesChartOptions = {
            chart: {
                type: 'area',
                height: 350,
                toolbar: {
                    show: false
                },
                background: 'transparent'
            },
            series: [{
                name: 'Faturamento',
                data: [0]
            }],
            xaxis: {
                categories: [''],
                labels: {
                    style: {
                        colors: '#6b7280',
                        fontSize: '12px',
                        fontWeight: 500
                    }
                },
                axisBorder: {
                    show: false
                },
                axisTicks: {
                    show: false
                }
            },
            yaxis: {
                labels: {
                    formatter: (value) => `R$ ${value.toFixed(0)}`,
                    style: {
                        colors: '#6b7280',
                        fontSize: '12px',
                        fontWeight: 500
                    }
                }
            },
            colors: ['#667eea'],
            fill: {
                type: 'gradient',
                gradient: {
                    shadeIntensity: 1,
                    opacityFrom: 0.7,
                    opacityTo: 0.1,
                    stops: [0, 90, 100]
                }
            },
            stroke: {
                curve: 'smooth',
                width: 3
            },
            dataLabels: {
                enabled: false
            },
            grid: {
                borderColor: '#e5e7eb',
                strokeDashArray: 4,
                xaxis: {
                    lines: {
                        show: false
                    }
                }
            },
            markers: {
                size: 6,
                colors: ['#667eea'],
                strokeColors: '#fff',
                strokeWidth: 2,
                hover: {
                    size: 8
                }
            },
            tooltip: {
                theme: 'dark',
                style: {
                    fontSize: '12px',
                    fontFamily: 'Inter, sans-serif'
                }
            }
        };

        const salesChart = new ApexCharts(document.querySelector("#sales-chart"), salesChartOptions);
        salesChart.render();

        const topProductsChartOptions = {
            chart: {
                type: 'donut',
                height: 350,
                background: 'transparent'
            },
            series: [1],
            labels: ['Carregando...'],
            legend: {
                position: 'bottom',
                horizontalAlign: 'center',
                fontSize: '12px',
                fontWeight: 500,
                labels: {
                    colors: '#6b7280'
                }
            },
            plotOptions: {
                pie: {
                    donut: {
                        size: '70%',
                        labels: {
                            show: true,
                            total: {
                                show: true,
                                label: 'Total',
                                fontSize: '14px',
                                fontWeight: 600,
                                color: '#374151',
                                formatter: function (w) {
                                    return w.globals.seriesTotals.reduce((a, b) => a + b, 0)
                                }
                            }
                        }
                    }
                }
            },
            colors: ['#10b981', '#3b82f6', '#6366f1', '#8b5cf6', '#ec4899', '#f59e0b'],
            dataLabels: {
                enabled: true,
                style: {
                    colors: ['#fff'],
                    fontSize: '12px',
                    fontWeight: 600
                },
                dropShadow: {
                    enabled: true,
                    top: 1,
                    left: 1,
                    blur: 2,
                    opacity: 0.5
                }
            },
            stroke: {
                width: 2,
                colors: ['#fff']
            },
            tooltip: {
                theme: 'dark',
                style: {
                    fontSize: '12px',
                    fontFamily: 'Inter, sans-serif'
                }
            },
            responsive: [{
                breakpoint: 480,
                options: {
                    chart: {
                        width: 200
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }]
        };

        const topProductsChart = new ApexCharts(document.querySelector("#top-products-chart"), topProductsChartOptions);
        topProductsChart.render();

        // Authentication functions
        async function checkLoginStatus() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return null;
            }
            return session.user;
        }

        document.getElementById('logout-button').addEventListener('click', async () => {
            await supabaseClient.auth.signOut();
            window.location.href = 'index.html';
        });        // FUN√á√ÉO ATUALIZADA PARA BUSCAR AS √öLTIMAS 10 VENDAS COM DADOS DE DESCONTO E C√ÅLCULO DE LUCRO CORRETO
        async function fetchRecentSales() {
    try {
        console.log('üîç Buscando √∫ltimas 10 vendas com dados de desconto...');

        const { data: sales, error: salesError } = await supabaseClient
            .from('vendas')
            .select(`
                id,
                valor_total,
                desconto_aplicado,
                tipo_desconto,
                valor_desconto,
                created_at,
                itens_venda(
                    quantidade,
                    preco_unitario_na_venda,
                    custo_unitario_na_venda,
                    produtos!inner(
                        id,
                        nome,
                        categoria,
                        preco_custo,
                        preco_venda,
                        preco_venda_pacote,
                        fator_conversao,
                        codigo_sku_pacote
                    )
                )
            `)
            .order('created_at', { ascending: false })
            .limit(10);

        if (salesError) {
            throw salesError;
        }

        const processedSales = [];

        sales.forEach(sale => {
            sale.itens_venda.forEach(item => {
                const product = item.produtos;
                if (!product) return;

                const saleDate = new Date(sale.created_at);
                const quantity = item.quantidade;
                const unitPriceSold = item.preco_unitario_na_venda;
                const unitCost = item.custo_unitario_na_venda;

                let saleType = 'unit';
                let originalUnitPrice = product.preco_venda;

                if (product.fator_conversao && product.preco_venda_pacote && unitPriceSold.toFixed(2) === (product.preco_venda_pacote / product.fator_conversao).toFixed(2)) {
                    saleType = 'package';
                    originalUnitPrice = product.preco_venda_pacote / product.fator_conversao;
                }

                const itemDiscountProporcional = (originalUnitPrice - unitPriceSold) * quantity;
                const itemRevenueLiquido = unitPriceSold * quantity;
                const itemCostTotal = unitCost * quantity;
                const itemProfit = itemRevenueLiquido - itemCostTotal;

                processedSales.push({
                    saleId: sale.id,
                    saleDate: saleDate,
                    productName: product.nome,
                    category: product.categoria,
                    saleType: saleType,
                    quantity: quantity,
                    unitPrice: unitPriceSold,
                    itemDiscountProporcional: itemDiscountProporcional,
                    itemRevenueLiquido: itemRevenueLiquido,
                    itemProfit: itemProfit
                });
            });
        });

        const sortedRecentSales = processedSales.sort((a, b) => b.saleDate.getTime() - a.saleDate.getTime());

        return sortedRecentSales;

    } catch (error) {
        console.error('‚ùå Erro ao buscar √∫ltimas vendas:', error);
        return [];
    }
}

        // FUN√á√ÉO ATUALIZADA PARA RENDERIZAR AS √öLTIMAS VENDAS COM NOVA ORDEM: PRE√áO UNIT., DESCONTO, FATURAMENTO
        function renderRecentSales(salesItems) {
            const recentSalesEl = document.getElementById('recent-sales');
            recentSalesEl.innerHTML = '';

            if (salesItems.length === 0) {
                recentSalesEl.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-history"></i>
                            <p>Nenhuma venda recente encontrada</p>
                        </td>
                    </tr>
                `;
                return;
            }

            salesItems.forEach((item) => {
                const formattedDate = item.saleDate.toLocaleDateString('pt-BR');
                const formattedTime = item.saleDate.toLocaleTimeString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const typeBadge = item.saleType === 'package'
                    ? '<span class="type-badge-package"><i class="fas fa-boxes"></i>FARDO</span>'
                    : '<span class="type-badge-unit"><i class="fas fa-cube"></i>UNIDADE</span>';

                let discountBadge = '';
                if (item.itemDiscountProporcional > 0) {
                    discountBadge = `<span class="discount-badge"><i class="fas fa-tag"></i> ${formatCurrency(item.itemDiscountProporcional)}</span>`;
                } else {
                    discountBadge = '<span class="text-gray-400 text-xs">Sem desconto</span>';
                }

                const row = `
                    <tr class="hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all duration-200">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <div class="text-sm font-semibold text-gray-900">${formattedDate}</div>
                                <div class="text-xs text-gray-500">${formattedTime}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-semibold text-gray-900">${item.productName}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs font-medium">
                                ${item.category}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${typeBadge}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium">
                                ${item.quantity}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                            ${formatCurrency(item.unitPrice)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${discountBadge}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">
                            ${formatCurrency(item.itemRevenueLiquido)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${item.itemProfit >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${formatCurrency(item.itemProfit)}
                        </td>
                    </tr>
                `;
                recentSalesEl.innerHTML += row;
            });
        }

        // Main function to fetch and display data
        async function fetchDashboardData(period = 'today') {
            try {
                let startDate = new Date();
                const now = new Date();
                if (period === 'today') {
                    startDate.setHours(0, 0, 0, 0);
                } else if (period === 'last7days') {
                    startDate.setDate(now.getDate() - 6);
                    startDate.setHours(0, 0, 0, 0);
                } else if (period === 'this_month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                }

                const salesPromise = supabaseClient.from('vendas').select(`valor_total, desconto_aplicado, created_at, itens_venda(quantidade, custo_unitario_na_venda, produtos(nome))`).gte('created_at', startDate.toISOString());
                const lowStockPromise = supabaseClient.rpc('get_low_stock_count');
                const recentSalesPromise = fetchRecentSales(); // Usar nossa nova fun√ß√£o com detec√ß√£o de tipo E DESCONTO

                const [salesResult, lowStockResult, recentSalesData] = await Promise.all([salesPromise, lowStockPromise, recentSalesPromise]);
                const { data: sales, error: salesError } = salesResult;
                const { data: lowStockCount, error: lowStockError } = lowStockResult;

                if (salesError || lowStockError) {
                    throw salesError || lowStockError;
                }

                // Calculations for KPIs
                let totalRevenueLiquido = 0; // Faturamento l√≠quido
                let totalCost = 0;
                const productSales = {};
                sales.forEach(sale => {
                    totalRevenueLiquido += sale.valor_total; // valor_total j√° √© o l√≠quido
                    sale.itens_venda.forEach(item => {
                        totalCost += (item.custo_unitario_na_venda || 0) * item.quantidade;
                        if (item.produtos) {
                            productSales[item.produtos.nome] = (productSales[item.produtos.nome] || 0) + item.quantidade;
                        }
                    });
                });

                const grossProfit = totalRevenueLiquido - totalCost; // Lucro bruto agora √© lucro l√≠quido
                const profitMargin = totalRevenueLiquido > 0 ? (grossProfit / totalRevenueLiquido) * 100 : 0;

                // Update KPIs with animation
                document.getElementById('faturamento-valor').textContent = formatCurrency(totalRevenueLiquido);
                document.getElementById('lucro-valor').textContent = formatCurrency(grossProfit);
                document.getElementById('margem-valor').textContent = `${profitMargin.toFixed(1).replace('.', ',')}%`;
                document.getElementById('estoque-baixo-valor').textContent = lowStockCount || 0;

                // Update sales chart
                const salesByDate = {};
                let dayCursor = new Date(startDate);
                while (dayCursor <= now) {
                    const label = dayCursor.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    salesByDate[label] = 0;
                    dayCursor.setDate(dayCursor.getDate() + 1);
                }

                sales.forEach(sale => {
                    const saleDateLabel = new Date(sale.created_at).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    if (salesByDate[saleDateLabel] !== undefined) {
                        salesByDate[saleDateLabel] += sale.valor_total;
                    }
                });

                salesChart.updateOptions({
                    series: [{ data: Object.values(salesByDate) }],
                    xaxis: { categories: Object.keys(salesByDate) }
                });

                // Update top products chart
                const topProducts = Object.entries(productSales).sort((a, b) => b[1] - a[1]).slice(0, 5);
                topProductsChart.updateOptions({
                    series: topProducts.length > 0 ? topProducts.map(p => p[1]) : [1],
                    labels: topProducts.length > 0 ? topProducts.map(p => p[0]) : ['Nenhuma venda no per√≠odo'],
                });

                // Render recent sales com os novos dados detalhados incluindo tipo E DESCONTO
                renderRecentSales(recentSalesData);
                
                showToast('Dashboard atualizado com sucesso!', 'success');
                
            } catch (error) {
                console.error("Erro ao carregar dados do dashboard:", error);
                showToast('Erro ao carregar dados do dashboard.', 'error');
            }
        }

        // Event listener for period filters
        document.getElementById('period-filters').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                fetchDashboardData(e.target.dataset.period);
            }
        });

        // Event listener for low stock filter button
        document.getElementById('low-stock-filter-btn').addEventListener('click', () => {
            window.location.href = 'inventario.html?filtro=estoque_baixo';
        });

        // FUN√á√ÉO ATUALIZADA: Page initialization com busca de dados do plano
        async function initializePage() {
            currentUser = await checkLoginStatus();
            if (currentUser) {
                // Buscar dados do perfil e do plano
                const planData = await fetchUserPlanData();
                
                // Exibir alerta do plano
                displayPlanAlert(planData);
                
                // Atualizar mensagem de boas-vindas
                if (planData && planData.full_name) {
                    document.getElementById('welcome-message').innerHTML = `Ol√°, <span class="font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">${planData.full_name.split(' ')[0]}</span>!`;
                }
                
                // Inicializar dashboard
                document.querySelector('.filter-btn[data-period="today"]').classList.add('active');
                await fetchDashboardData('today');
                document.getElementById('dashboard-content').classList.remove('opacity-0');
            }
        }

        initializePage();
    </script>
</body>
</html>


                    .limit(20); // Buscar mais vendas para garantir que tenhamos 10 itens

                if (salesError) throw salesError;

                console.log('üìä Dados das √∫ltimas vendas recebidos:', { totalSales: sales?.length || 0, sales });

                const recentSalesItems = [];

                // Processar cada venda para extrair os itens
                if (sales && Array.isArray(sales)) {
                    sales.forEach((sale) => {
                        // Valida√ß√£o da venda
                        if (!sale || typeof sale.valor_total !== 'number') {
                            console.warn('‚ö†Ô∏è Venda inv√°lida:', sale);
                            return;
                        }

                        const saleDiscount = Number(sale.desconto_aplicado) || 0; // Desconto total da venda
                        const saleGrossTotal = sale.itens_venda.reduce((sum, saleItem) => {
                            return sum + (Number(saleItem.quantidade) * Number(saleItem.preco_unitario_na_venda));
                        }, 0); // Faturamento bruto total da venda

                        // Processar itens da venda
                        if (sale.itens_venda && Array.isArray(sale.itens_venda)) {
                            sale.itens_venda.forEach((item) => {
                                // Valida√ß√£o do item
                                if (!item || !item.produtos) {
                                    console.warn('‚ö†Ô∏è Item sem produto associado:', item);
                                    return;
                                }

                                const product = item.produtos;
                                
                                // Valida√ß√£o do produto
                                if (!product.id) {
                                    console.warn('‚ö†Ô∏è Produto sem ID v√°lido:', product);
                                    return;
                                }

                                // Valida√ß√£o dos valores num√©ricos
                                const quantidade = Number(item.quantidade) || 0;
                                const precoUnitario = Number(item.preco_unitario_na_venda) || 0;
                                const custoUnitario = Number(item.custo_unitario_na_venda) || Number(product.preco_custo) || 0;

                                if (quantidade <= 0) {
                                    console.warn('‚ö†Ô∏è Quantidade inv√°lida:', quantidade);
                                    return;
                                }

                                // DETEC√á√ÉO DO TIPO DE VENDA (UNIDADE OU FARDO)
                                let saleType = 'unit'; // Padr√£o: unidade
                                
                                // Verificar se o produto tem configura√ß√£o de fardo
                                const hasPackageConfig = product.preco_venda_pacote && 
                                                       product.fator_conversao && 
                                                       product.fator_conversao > 1;
                                
                                if (hasPackageConfig) {
                                    // Se o pre√ßo unit√°rio da venda √© igual ao pre√ßo do fardo, √© uma venda de fardo
                                    const packagePrice = Number(product.preco_venda_pacote);
                                    if (Math.abs(precoUnitario - packagePrice) < 0.01) { // Toler√¢ncia para compara√ß√£o de float
                                        saleType = 'package';
                                    }
                                }

                                const itemRevenueBruto = precoUnitario * quantidade;
                                let itemDiscountProporcional = 0;
                                if (saleGrossTotal > 0) {
                                    itemDiscountProporcional = (itemRevenueBruto / saleGrossTotal) * saleDiscount;
                                }
                                const itemRevenueLiquido = itemRevenueBruto - itemDiscountProporcional;
                                const itemCost = custoUnitario * quantidade;
                                const itemProfit = itemRevenueLiquido - itemCost; // LUCRO REAL AP√ìS DESCONTO

                                // Adicionar item √† lista de vendas recentes COM DADOS DE DESCONTO
                                recentSalesItems.push({
                                    saleId: sale.id,
                                    saleDate: new Date(sale.created_at),
                                    productName: product.nome || 'Produto sem nome',
                                    category: product.categoria || 'Sem Categoria',
                                    saleType: saleType, // 'unit' ou 'package'
                                    quantity: quantidade,
                                    unitPrice: precoUnitario,
                                    itemRevenueBruto: itemRevenueBruto, // Faturamento bruto do item
                                    itemRevenueLiquido: itemRevenueLiquido, // Faturamento l√≠quido do item
                                    itemCost: itemCost,
                                    itemProfit: itemProfit,
                                    saleDiscountTotal: saleDiscount, // Desconto total da venda
                                    itemDiscountProporcional: itemDiscountProporcional // Desconto proporcional do item
                                });
                            });
                        }
                    });
                }

                // Ordenar por data (mais recente primeiro) e pegar apenas os 10 primeiros
                const sortedRecentSales = recentSalesItems
                    .sort((a, b) => b.saleDate - a.saleDate)
                    .slice(0, 10);

                console.log('‚úÖ √öltimas 10 vendas processadas com tipos e desconto:', sortedRecentSales);
                return sortedRecentSales;

            } catch (error) {
                console.error('‚ùå Erro ao buscar √∫ltimas vendas:', error);
                return [];
            }
        }

        // FUN√á√ÉO ATUALIZADA PARA RENDERIZAR AS √öLTIMAS VENDAS COM NOVA ORDEM: PRE√áO UNIT., DESCONTO, FATURAMENTO
        function renderRecentSales(salesItems) {
            const recentSalesEl = document.getElementById('recent-sales');
            recentSalesEl.innerHTML = '';

            if (salesItems.length === 0) {
                recentSalesEl.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-history"></i>
                            <p>Nenhuma venda recente encontrada</p>
                        </td>
                    </tr>
                `;
                return;
            }

            salesItems.forEach((item) => {
                const formattedDate = item.saleDate.toLocaleDateString('pt-BR');
                const formattedTime = item.saleDate.toLocaleTimeString('pt-BR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const typeBadge = item.saleType === 'package'
                    ? '<span class="type-badge-package"><i class="fas fa-boxes"></i>FARDO</span>'
                    : '<span class="type-badge-unit"><i class="fas fa-cube"></i>UNIDADE</span>';

                let discountBadge = '';
                if (item.itemDiscountProporcional > 0) {
                    discountBadge = `<span class="discount-badge"><i class="fas fa-tag"></i> ${formatCurrency(item.itemDiscountProporcional)}</span>`;
                } else {
                    discountBadge = '<span class="text-gray-400 text-xs">Sem desconto</span>';
                }

                const row = `
                    <tr class="hover:bg-gradient-to-r hover:from-blue-50 hover:to-purple-50 transition-all duration-200">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <div class="text-sm font-semibold text-gray-900">${formattedDate}</div>
                                <div class="text-xs text-gray-500">${formattedTime}</div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-semibold text-gray-900">${item.productName}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="bg-gray-100 text-gray-800 px-2 py-1 rounded-full text-xs font-medium">
                                ${item.category}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${typeBadge}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                            <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-medium">
                                ${item.quantity}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-gray-900">
                            ${formatCurrency(item.unitPrice)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${discountBadge}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-green-600">
                            ${formatCurrency(item.itemRevenueLiquido)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold ${item.itemProfit >= 0 ? 'text-green-600' : 'text-red-600'}">
                            ${formatCurrency(item.itemProfit)}
                        </td>
                    </tr>
                `;
                recentSalesEl.innerHTML += row;
            });
        }

        // Main function to fetch and display data
        async function fetchDashboardData(period = 'today') {
            try {
                let startDate = new Date();
                const now = new Date();
                if (period === 'today') {
                    startDate.setHours(0, 0, 0, 0);
                } else if (period === 'last7days') {
                    startDate.setDate(now.getDate() - 6);
                    startDate.setHours(0, 0, 0, 0);
                } else if (period === 'this_month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                }

                const salesPromise = supabaseClient.from('vendas').select(`valor_total, desconto_aplicado, created_at, itens_venda(quantidade, custo_unitario_na_venda, produtos(nome))`).gte('created_at', startDate.toISOString());
                const lowStockPromise = supabaseClient.rpc('get_low_stock_count');
                const recentSalesPromise = fetchRecentSales(); // Usar nossa nova fun√ß√£o com detec√ß√£o de tipo E DESCONTO

                const [salesResult, lowStockResult, recentSalesData] = await Promise.all([salesPromise, lowStockPromise, recentSalesPromise]);
                const { data: sales, error: salesError } = salesResult;
                const { data: lowStockCount, error: lowStockError } = lowStockResult;

                if (salesError || lowStockError) {
                    throw salesError || lowStockError;
                }

                // Calculations for KPIs
                let totalRevenueLiquido = 0; // Faturamento l√≠quido
                let totalCost = 0;
                const productSales = {};
                sales.forEach(sale => {
                    totalRevenueLiquido += sale.valor_total; // valor_total j√° √© o l√≠quido
                    sale.itens_venda.forEach(item => {
                        totalCost += (item.custo_unitario_na_venda || 0) * item.quantidade;
                        if (item.produtos) {
                            productSales[item.produtos.nome] = (productSales[item.produtos.nome] || 0) + item.quantidade;
                        }
                    });
                });

                const grossProfit = totalRevenueLiquido - totalCost; // Lucro bruto agora √© lucro l√≠quido
                const profitMargin = totalRevenueLiquido > 0 ? (grossProfit / totalRevenueLiquido) * 100 : 0;

                // Update KPIs with animation
                document.getElementById('faturamento-valor').textContent = formatCurrency(totalRevenueLiquido);
                document.getElementById('lucro-valor').textContent = formatCurrency(grossProfit);
                document.getElementById('margem-valor').textContent = `${profitMargin.toFixed(1).replace('.', ',')}%`;
                document.getElementById('estoque-baixo-valor').textContent = lowStockCount || 0;

                // Update sales chart
                const salesByDate = {};
                let dayCursor = new Date(startDate);
                while (dayCursor <= now) {
                    const label = dayCursor.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    salesByDate[label] = 0;
                    dayCursor.setDate(dayCursor.getDate() + 1);
                }

                sales.forEach(sale => {
                    const saleDateLabel = new Date(sale.created_at).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    if (salesByDate[saleDateLabel] !== undefined) {
                        salesByDate[saleDateLabel] += sale.valor_total;
                    }
                });

                salesChart.updateOptions({
                    series: [{ data: Object.values(salesByDate) }],
                    xaxis: { categories: Object.keys(salesByDate) }
                });

                // Update top products chart
                const topProducts = Object.entries(productSales).sort((a, b) => b[1] - a[1]).slice(0, 5);
                topProductsChart.updateOptions({
                    series: topProducts.length > 0 ? topProducts.map(p => p[1]) : [1],
                    labels: topProducts.length > 0 ? topProducts.map(p => p[0]) : ['Nenhuma venda no per√≠odo'],
                });

                // Render recent sales com os novos dados detalhados incluindo tipo E DESCONTO
                renderRecentSales(recentSalesData);
                
                showToast('Dashboard atualizado com sucesso!', 'success');
                
            } catch (error) {
                console.error("Erro ao carregar dados do dashboard:", error);
                showToast('Erro ao carregar dados do dashboard.', 'error');
            }
        }

        // Event listener for period filters
        document.getElementById('period-filters').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('active')) {
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                fetchDashboardData(e.target.dataset.period);
            }
        });

        // Event listener for low stock filter button
        document.getElementById('low-stock-filter-btn').addEventListener('click', () => {
            window.location.href = 'inventario.html?filtro=estoque_baixo';
        });

        // FUN√á√ÉO ATUALIZADA: Page initialization com busca de dados do plano
        async function initializePage() {
            currentUser = await checkLoginStatus();
            if (currentUser) {
                // Buscar dados do perfil e do plano
                const planData = await fetchUserPlanData();
                
                // Exibir alerta do plano
                displayPlanAlert(planData);
                
                // Atualizar mensagem de boas-vindas
                if (planData && planData.full_name) {
                    document.getElementById('welcome-message').innerHTML = `Ol√°, <span class="font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">${planData.full_name.split(' ')[0]}</span>!`;
                }
                
                // Inicializar dashboard
                document.querySelector('.filter-btn[data-period="today"]').classList.add('active');
                await fetchDashboardData('today');
                document.getElementById('dashboard-content').classList.remove('opacity-0');
            }
        }

        initializePage();
    </script>
</body>
</html>


